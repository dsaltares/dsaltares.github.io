<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Migrating Teamfindr from CRA&#43;Express&#43;AWS to Next.js&#43;Vercel &middot; Engineering Leadership &amp; Software Development</title>

  
  <link rel="stylesheet" href="../css/poole.css">
  <link rel="stylesheet" href="../css/hyde.css">
  <link rel="stylesheet" href="../css/poole-overrides.css">
  <link rel="stylesheet" href="../css/hyde-overrides.css">
  <link rel="stylesheet" href="../css/hyde-x.css">
  <link rel="stylesheet" href="../css/highlight/github-dark-dimmed.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../touch-icon-144-precomposed.png">
  <link href="../img/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="TeamFindrÂ is an app to organise games with friends. I migrated it from a CRA to a Next.js app. In this post, I cover why, the process and some resulting metrics.">
  <meta name="keywords" content="TeamFindr,side project,CRA,create React app,Next.js,AWS,Vercel,React,EC2,Docker,software migration,performance,REST API">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-4440744-3', 'auto');
    ga('send', 'pageview');
  </script>
  

  

  
  <link rel="canonical" href="https://saltares.com/migrating-teamfindr-from-cra-express-aws-to-next.js-vercel/" itemprop="url" />
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="../"><img src="../img/profile.jpg"
             alt="profile-picture" id="profile-img" title="David Saltares"></a>
      <h1><a href="../">David Saltares</a></h1>
      <p class="lead">Engineering Leadership &amp; Software Development</p>
      <div class="subscribe"><a href="https://tinyletter.com/dsaltares/">âœ‰ï¸ Subscribe</a></div>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="../">Blog</a></li>
      
      <li class="sidebar-nav-item"><a href="../about">About</a></li>
      
      <li class="sidebar-nav-item"><a href="../apps-tools">Apps &amp; Tools</a></li>
      
      <li class="sidebar-nav-item"><a href="../game-jams">Game Jams</a></li>
      
      <li class="sidebar-nav-item"><a href="../games">Games</a></li>
      
      <li class="sidebar-nav-item"><a href="../libgdx-cross-platform-game-development-cookbook">Libgdx Cookbook</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a aria-label="Github profile" href="http://github.com/dsaltares"><i class="fa fa-github-square fa-2x"></i></a>
      
      
      <a aria-label="LinkedIn profile" href="https://www.linkedin.com/in/davidsaltares"><i class="fa fa-linkedin-square fa-2x"></i></a>
      
      
      <a aria-label="Twitter profile" href="http://twitter.com/d_saltares"><i class="fa fa-twitter-square fa-2x"></i></a>
      
      <a aria-label="RSS" href="../index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-2x"></i></a>
      </li>
    </ul>

    

    <div class="copyright">
      <p>&copy; 2022 David Saltares.</p>
    </div>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Migrating Teamfindr from CRA&#43;Express&#43;AWS to Next.js&#43;Vercel</h1>
    <span class="post-date">Aug 16, 2022 &middot; 4 minute read &middot; <a href="https://saltares.com/migrating-teamfindr-from-cra-express-aws-to-next.js-vercel/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="../categories/development">Development</a>
    </span>
     
    <p>
  <img src="../img/teamfindr/teamfindr_00001.png" alt="TeamFindr header banner">


<a href="https://teamfindr.saltares.com/">TeamFindr</a>Â is a mobile-first web application that helps you find nearby pick-up games, organise games with your friends and find extra players. My friend <a href="https://www.linkedin.com/in/cristian-iordan-26b1abb7/">Cristi</a> and I built it during the pandemic. Back then, I used <a href="https://create-react-app.dev/">CRA</a> for the client and <a href="https://expressjs.com/">Express</a> for the REST API. The client was deployed to <a href="https://create-react-app.dev/docs/deployment/#github-pages">Github pages</a> and the server to an <a href="https://github.com/dsaltares/teamfindr/blob/784c972d5e2bd1e7cd3d213c462d8a1cc0839485/.github/workflows/lint_test_and_deploy.yaml#L75-L108">EC2 machine on AWS via Docker</a>. The whole thing is <a href="https://github.com/dsaltares/teamfindr">open source</a>.</p>
<p>Recently, I migrated TeamFindr to <a href="https://nextjs.org/">Next.js</a> and deployed it to <a href="https://vercel.com/">Vercel</a>. In this article, I go over the reasons for the change, the actual migration process and some comparative metrics.</p>
<h2 id="reasons-to-migrate">ğŸ¤”Â Reasons to migrate</h2>
<p>What prompted me to migrate was that the EC2 free tier in my AWS account expired. My <code>t2.micro</code> instance was ~$10/month, and Vercelâ€™s free tier limits are more than enough to keep TeamFindr online. My rule is that side projects must remain free to run ğŸ˜….</p>
<p>There were other reasons as well.</p>
<ul>
<li>â›°ï¸Â Next.js and Vercel support <a href="https://nextjs.org/docs/api-routes/introduction">API routes</a>, which allows me to keep both client and API in the same deployment unit.</li>
<li>ğŸ‰Â A single codebase means sharing typescript types between client and API is more manageable without the need for complex monorepo setups like yarn workspaces.</li>
<li>ğŸ”¥Â Vercel offers zero-config deployments and eliminates a bunch of technologies from my project. Just Vercel now replaces Docker, ECR, Nginx and EC2. Fewer tools and less config mean easier reproducibility.</li>
<li>ğŸ”’Â There is no vendor lock-in because one can quickly <a href="https://blog.logrocket.com/deploying-nextjs-aws-serverless-next-js/#features">deploy Next.js apps elsewhere</a>.</li>
<li>ğŸï¸Â Next.js developer experience is better, and you get other niceties like automatic code splitting and optimised images.</li>
</ul>
<h2 id="the-migration-process">ğŸ¦œÂ The migration process</h2>
<p>Overall, it was a smooth ride that only took a couple of days from start to shipping.</p>
<p>The first step was to port the <strong>client</strong> from CRA to Next.js. The original application was a client-rendered <a href="https://developer.mozilla.org/en-US/docs/Glossary/SPA">SPA</a>, and I kept it that way for several reasons.</p>
<ul>
<li>The entire package assumed it runs on the client. The app uses <code>window</code> and other browser APIs such as <a href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API"><code>navigator.geolocation</code></a>.</li>
<li>I didnâ€™t have to bother migrating away from <a href="https://reactrouter.com/"><code>react-router</code></a> to Next.js&rsquo;s router.</li>
<li>The old app used <a href="https://v5.reactrouter.com/web/api/HashRouter"><code>HashRouter</code></a>. Switching to regular routing would mean breaking links such as <a href="https://teamfindr.saltares.com/#/venues/8d37b22c-6563-4723-a97c-a5fcc0747695"><code>https://teamfindr.saltares.com/#/venues/8d37b22c-6563-4723-a97c-a5fcc0747695</code></a>.</li>
</ul>
<p>I followed the Next.js docs to <a href="https://nextjs.org/docs/migrating/from-create-react-app">migrate from a CRA</a>, particularly <a href="https://nextjs.org/docs/migrating/from-create-react-app#single-page-app-spa">the SPA section</a>. At that point, I had a Next.js-powered frontend that talked to my old Express API. To test components in isolation, I used <a href="https://storybook.js.org/">Storybook</a>, so I followed their official <a href="https://storybook.js.org/blog/get-started-with-storybook-and-next-js/">guide to set it up in Next.js</a>, and all my old stories worked perfectly.</p>
<p>Migrating the <strong>API</strong> was slightly trickier, especially getting <a href="https://www.passportjs.org/">passport</a> authentication to work. My Express server relied on a bunch of middleware: <code>passport</code>, <a href="https://www.npmjs.com/package/cookie-session"><code>cookie-session</code></a>, <a href="https://www.npmjs.com/package/cookie-parser"><code>cookie-parser</code></a>, logging, protected routes, etc.</p>
<p>Fortunately, I discovered <a href="https://www.npmjs.com/package/next-connect">next-connect</a>, which you can plug into your Next.js API routes and inject all your middleware. That made it super easy to keep middleware and endpoint handlers mostly as-is.</p>
<p>This is what my API routes look like.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getEvents</span>: <span style="color:#66d9ef">Handler</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> ({ <span style="color:#a6e22e">query</span>, <span style="color:#a6e22e">user</span> }) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">events</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">searchEvents</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">query</span>: <span style="color:#66d9ef">parseSearchEventsQuery</span>(<span style="color:#a6e22e">query</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userId</span>: <span style="color:#66d9ef">user?.id</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">status</span>: <span style="color:#66d9ef">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">events</span> },
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">createRoute</span>([
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;get&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">handler</span>: <span style="color:#66d9ef">getEvents</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">requiresAuth</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]);
</span></span></code></pre></div><p>And hereâ€™s part of my <code>createRoute</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">createRoute</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">endpoints</span>: <span style="color:#66d9ef">EndpointDefinition</span>[]) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">router</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">connect</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">cors</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">origin</span>: <span style="color:#66d9ef">Config.hostUrl</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">methods</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GET,HEAD,PUT,PATCH,POST,DELETE&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">credentials</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">cookieSession</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;session&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">keys</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">authentication</span>.<span style="color:#a6e22e">cookieKey</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">maxAge</span>: <span style="color:#66d9ef">365</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#75715e">// 1 year
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">overwrite</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">cookieParser</span>())
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">passport</span>.<span style="color:#a6e22e">initialize</span>())
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">passport</span>.<span style="color:#a6e22e">session</span>())
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">withRenewSession</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">withRequestLogger</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">withAuthenticatedUser</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">endpoints</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">endpoint</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">router</span>[<span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">method</span>](<span style="color:#a6e22e">createRawHandler</span>(<span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">handler</span>));
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">router</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>As an aside, <a href="https://next-auth.js.org/">NextAuth</a> makes it far easier to get authentication in a Next.js app. I would totally use it if I were to build the app from scratch.</p>
<p>At last, I could point the client to talk to the new Next.js API routes.</p>
<p><strong>Shipping</strong> was the easiest part.</p>
<ol>
<li>Merge to the <code>main</code> branch.</li>
<li>Configure a new app in Vercel and get it deployed.</li>
<li>Make the <code>teamfindr.saltares.com</code> domain point at Vercel.</li>
<li>Delete the EC2 instance in AWS.</li>
<li>Save $10/month ğŸ¤‘ğŸ˜….</li>
</ol>
<h2 id="before-and-after">ğŸ“ˆÂ Before and after</h2>
<p>TeamFindr has 18% less code and deploys 54% faster as a Next.js app running on Vercel than a CRA+Express app on EC2. The REST API response times are mostly unchanged except for cold starts. When you hit a cold route, response times may <a href="https://aws.amazon.com/blogs/compute/operating-lambda-performance-optimization-part-1/#:~:text=According%20to%20an%20analysis%20of,ms%20to%20over%201%20second.">increase by between 100 and 1000ms</a>. Given the performance requirements of TeamFindr, I would say this is a fair tradeoff, and the benefits far outweigh the compromises.</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Before</th>
<th>After</th>
<th>Change</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lines of code</td>
<td>12663</td>
<td>10414</td>
<td>-18%</td>
</tr>
<tr>
<td>Deployment times</td>
<td>~5m30s</td>
<td>~2m30s</td>
<td>-54%</td>
</tr>
<tr>
<td>API response times (average)</td>
<td>~80-200ms</td>
<td>~80-300ms</td>
<td>Negligible</td>
</tr>
</tbody>
</table>
<p>ğŸ™ŒÂ Thanks for reading. I hope you find my experience migrating a CRA app to Next.js helpful.</p>

  </div>
  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'siondream';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


<script src="../js/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script>
<script src="../js/load-photoswipe.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
</body>
</html>

