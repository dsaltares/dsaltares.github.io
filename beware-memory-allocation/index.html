<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/touch-icon-144-precomposed.png"/><title>Beware memory allocation · David Saltares</title><meta name="robots" content="index,follow"/><meta name="description" content="Engineering Leadership &amp; Software Development"/><meta property="og:title" content="Beware memory allocation · David Saltares"/><meta property="og:description" content="Engineering Leadership &amp; Software Development"/><meta property="og:url" content="https://saltares.com/beware-memory-allocation"/><meta property="og:type" content="website"/><link rel="canonical" href="https://saltares.com/beware-memory-allocation"/><meta name="keywords" content=""/><meta name="next-head-count" content="12"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/592216306eff0874.css" as="style"/><link rel="stylesheet" href="/_next/static/css/592216306eff0874.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59abf025137dee37.js" defer=""></script><script src="/_next/static/chunks/framework-9b5d6ec4444c80fa.js" defer=""></script><script src="/_next/static/chunks/main-e42aac98337d61c6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-89283805d41ea493.js" defer=""></script><script src="/_next/static/chunks/c16184b3-9b756f0214555638.js" defer=""></script><script src="/_next/static/chunks/2cca2479-c0f2c9f2f2dc1702.js" defer=""></script><script src="/_next/static/chunks/252-64d0c1a5eecbfabd.js" defer=""></script><script src="/_next/static/chunks/167-7d296999b3b0013a.js" defer=""></script><script src="/_next/static/chunks/962-68c39fb6207889be.js" defer=""></script><script src="/_next/static/chunks/673-8982310ab2fdaad5.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-73432d84cbff39d9.js" defer=""></script><script src="/_next/static/mvqSgSk1RJnIqiv3GiBne/_buildManifest.js" defer=""></script><script src="/_next/static/mvqSgSk1RJnIqiv3GiBne/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap">@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizaRExUiTo99u79P0Y.woff) format('woff')}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizfRExUiTo99u79B_mh4Oo.woff) format('woff')}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizaRExUiTo99u79D0-ExcOPIDUg-g.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizaRExUiTo99u79D0aExcOPIDUg-g.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizaRExUiTo99u79D0yExcOPIDUg-g.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizaRExUiTo99u79D0KExcOPIDU.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizfRExUiTo99u79B_mh0OOtLR8a8zILig.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizfRExUiTo99u79B_mh0OqtLR8a8zILig.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizfRExUiTo99u79B_mh0OCtLR8a8zILig.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v17/jizfRExUiTo99u79B_mh0O6tLR8a8zI.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="flex flex-col md:flex-row font-sans text-xl w-full"><aside class="md:max-w-[360px] bg-primary px-10 py-10 text-white text-xl md:fixed md:top-0 md:left-0 md:h-full flex flex-col justify-end items-center md:items-start"><div><a href="/"><div class="mb-5"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27200%27%20height=%27200%27/%3e"/></span><img alt="profile picture" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="profile picture" src="/img/profile.webp" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="rounded-full" loading="lazy"/></noscript></span></div><h1 class="text-white font-bold text-4xl leading-10">David Saltares</h1></a></div><p class="text-contentLight text-2xl mb-5 leading-9 text-center md:text-left">Engineering Leadership &amp; Software Development</p><a href="https://tinyletter.com/dsaltares/"><p class="mb-5">✉️ Subscribe</p></a><nav><ul class="mb-5 flex flex-col items-center md:items-start list-none pl-0"><li class="leading-7"><a href="/">Blog</a></li><li class="leading-7"><a href="/about-me/">About</a></li><li class="leading-7"><a href="/apps-tools/">Apps &amp; Tools</a></li><li class="leading-7"><a href="/game-jams/">Game Jams</a></li><li class="leading-7"><a href="/games/">Games</a></li><li class="leading-7"><a href="/libgdx-cross-platform-game-development-cookbook/">Libgdx Cookbook</a></li></ul></nav><ul class="mb-5 list-none pl-0"><li class="inline"><a aria-label="Github profile" href="https://github.com/dsaltares"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="square-github" class="svg-inline--fa fa-square-github text-4xl mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"></path></svg></a></li><li class="inline"><a aria-label="Linkedin profile" href="https://www.linkedin.com/in/davidsaltares/"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin text-4xl mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li class="inline"><a aria-label="Twitter profile" href="https://twitter.com/dsaltares"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="square-twitter" class="svg-inline--fa fa-square-twitter text-4xl mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-48.9 158.8c.2 2.8.2 5.7.2 8.5 0 86.7-66 186.6-186.6 186.6-37.2 0-71.7-10.8-100.7-29.4 5.3.6 10.4.8 15.8.8 30.7 0 58.9-10.4 81.4-28-28.8-.6-53-19.5-61.3-45.5 10.1 1.5 19.2 1.5 29.6-1.2-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3a65.447 65.447 0 0 1-29.2-54.6c0-12.2 3.2-23.4 8.9-33.1 32.3 39.8 80.8 65.8 135.2 68.6-9.3-44.5 24-80.6 64-80.6 18.9 0 35.9 7.9 47.9 20.7 14.8-2.8 29-8.3 41.6-15.8-4.9 15.2-15.2 28-28.8 36.1 13.2-1.4 26-5.1 37.8-10.2-8.9 13.1-20.1 24.7-32.9 34z"></path></svg></a></li><li class="inline"><a aria-label="RSS feed" href="https://saltares.com/index.xml"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="square-rss" class="svg-inline--fa fa-square-rss text-4xl mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM96 136c0-13.3 10.7-24 24-24c137 0 248 111 248 248c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200c-13.3 0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24c83.9 0 152 68.1 152 152c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104c-13.3 0-24-10.7-24-24zm64 120c0 17.7-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32z"></path></svg></a></li><li class="inline"><a rel="me" href="https://fosstodon.org/@dsaltares"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon text-4xl mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></a></li></ul><p class="text-contentLight text-lg">© 2023 David Saltares.</p></aside><div class="md:max-w-[360px] w-full hidden md:block flex-grow-0 flex-shrink-0"></div><div class="flex flex-col main-content"><main class="w-full max-w-[720px] pr-4 py-10 pl-5 md:py-20 md:pl-20"><article class="text-content mb-10"><div><a href="/beware-memory-allocation/"><h1 class="font-bold text-4xl mb-2 text-primary">Beware memory allocation</h1></a><p class="flex text-contentLight mb-1">Jan 29 2013 · 8 min read<span> · </span><a class="text-contentLink" href="/beware-memory-allocation/#disqus_thread">Comments</a></p><div class="mb-3"><div class="flex flex-row gap-1"><a class="px-2 py-1 bg-slate-900 text-white rounded font-bold text-sm" href="/categories/games-development/">Games development</a></div></div></div><p>I bet you already know that keeping memory allocation under control in real time applications is absolutely essential. Bad memory management in non <a class="text-contentLink text-xl" href="http://en.wikipedia.org/wiki/Garbage_collection_(computer_science)">garbage collected languages</a>, say C++, results in irresponsible footprints. $deity forbid we incur in a std::bad_alloc exception! That can be a deal breaker for mobile phones or consoles. However, the other family of languages is what really haunts me. In Java, for instance, the consequences of not giving a monkey&#x27;s about memory won&#x27;t necessarily make your game crash. Nonetheless, it can be silently devastating to the point of dragging your frame rate below ground absent previous notice.</p>
<p>You don&#x27;t want that now, do you?</p>
<p>Please, let me take a step back and point out the irony of having to be extremely careful with memory usage in the presence of a garbage collector (GC) when dealing with real time problems. It&#x27;s often said that it takes the responsibility off you. In a beautiful world where code tastes like lollipop it would, but this is really not the case. At least not entirely.</p>
<p>This article is aimed at developers who code in GC environments to make real time applications. Concepts here also apply to broader fields in spite of the focus mainly being Java and games development using the libgdx framework. Actually, I decided to write this post after seeing the same performance related questions <a class="text-contentLink text-xl" href="http://www.badlogicgames.com/forum/viewtopic.php?f=11&amp;t=3572">over</a> and <a class="text-contentLink text-xl" href="http://www.badlogicgames.com/forum/viewtopic.php?f=11&amp;t=6785&amp;hilit=performance+garbage">over</a> again in the libgdx forums. Most of them are closely tied to memory allocation.</p>
<img class="mb-1" src="/img/wp/garbage-collector-strikes-back.webp" alt="garbage-collector-strikes-back.jpg"/>
<h3>Be aware of the GC and why it&#x27;s critical in mobile/consoles</h3>
<p>The GC is fired up every now and then and asks: <em>&quot;what objects are currently not being referenced by any variable?&quot;</em>. The next step is freeing the memory those objects were occupying so it becomes available for other purposes. It keeps the playground clean and neat and that&#x27;s awesome to some extent. Surely enough, this might not cause too much trouble in classic applications. However, it can be deadly in a situation where you have less than 1/60s to compute a discrete simulation step.</p>
<p>Note: I just told a white lie. JVM&#x27;s GC actually follows several strategies to free up unused memory as pointed out in <a class="text-contentLink text-xl" href="http://stackoverflow.com/questions/1582209/java-garbage-collector-when-does-it-collect">this Stack Overflow post</a>.</p>
<p>A common mistake, which I&#x27;ve made myself with <a class="text-contentLink text-xl" href="/freegemas/">Freegemas</a>, is to believe my game is well optimized because it runs flawlessly on an i7 machine. Don&#x27;t fool yourself, go on and deploy your libgdx app on a mid tier Android phone and see what happens.</p>
<blockquote>
<p>Oh well… This is disappointing…</p>
</blockquote>
<p>Mobile devices and consoles typically fall short on memory. You miss those 16GB of RAM, don&#x27;t you? Moreover, every time the GC decides to intervene, the stall becomes more noticeable due to the less powerful CPU.</p>
<blockquote>
<p>Oh noes!</p>
</blockquote>
<p>Long story short, we need to prevent this from happening as much as we possibly can.</p>
<h3>Cache temporal variables as data members</h3>
<p>It goes without saying that some memory allocation is needed. Don&#x27;t worry about loading your assets at sensible times as well as creating game objects to get things ready. Nevertheless, avoid making use of the new operator inside your game loop at any cost.</p>
<blockquote>
<p>Sometimes I do need some auxiliary, yet costly, objects to perform calculations every frame.</p>
</blockquote>
<p>Worry no more as you can make them private data members. As cheeky as it may sound, this will spare you a fair amount of problems.</p>
<p>I&quot;m currently working on a GLEED level system refactor and I think the renderer class could serve us as an perfect example. I use two Rectangle objects (Axis Aligned Bounding Boxes) to perform frustum culling: the first one represents the camera while the second one corresponds to the texture we might or might not render. Those two Rectangle objects don&#x27;t naturally belong to the GLEEDMapRenderer themselves, but why would I allocate memory for new instances every single frame. That&quot;d make the GC sad. Instead, take a look at this simplified snippet.</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">public class GleedMapRenderer implements MapRenderer, Disposable {

	// Renderer data
	private GleedMap m_map;
	private SpriteBatch m_batch;
	private boolean m_ownSpriteBatch;
	private float m_mpp;

	// Aux data for fustrum culling
	private Rectangle m_box = new Rectangle();
	private Rectangle m_camera = new Rectangle();

	public void render(OrthographicCamera camera) {
		m_camera.x = camera.position.x - camera.viewportWidth * 0.5f * camera.zoom;
		m_camera.y = camera.position.y - camera.viewportHeight * 0.5f * camera.zoom;
		m_camera.width = camera.viewportWidth *  camera.zoom;
		m_camera.height = camera.viewportHeight *  camera.zoom;

		setProjectionMatrix(camera.combined);

		MapLayers layers = m_map.getLayers();

		for (MapLayer layer : layers) {
			renderLayer(layer);
		}
	}

	private void renderLayer(MapLayer layer) {

		if (!layer.getVisible()) {
			return;
		}

		MapObjects objects = layer.getObjects();
		int numObjects = objects.getNumObjects();

		for (int j = 0; j &amp;lt; numObjects; ++j) {
			MapObject mapObject = objects.getObject(j);

			if (mapObject == null || !mapObject.getVisible()) {
				continue;
			}

			if (!(mapObject instanceof TextureMapObject)) {
				continue;
			}

			TextureMapObject texture = (TextureMapObject)mapObject;

			setBounds(texture);

			// If the image is in the frustum, draw it (culling)
			if (m_camera.overlaps(m_box) ||
			    m_camera.contains(m_box) ||
			    m_box.contains(m_camera)) {

				...
			}
		}
	}
}</code></pre></div>
<p>As illustrated above, the Rectangle instances are created along the renderer and properly set every frame. Consequently, what initially would have involved memory allocations, assignments and GC activity is reduced to just a few unavoidable assignments. Let&#x27;s mention it once again, in spite of rectangles being cheap, you don&#x27;t want to mess with the GC on mobile devices!</p>
<h3>Consider object pooling</h3>
<p>Unfortunately, at some point you will find yourself in the need of constantly creating dozens of big sized objects. It&#x27;s a common problem when dealing with spawning game entities, particle effects and the like. Say you&quot;re making a space shooter, of course you want hundreds of flashy explosions and lasers! You&quot;ll face a problem, that can drive the GC crazy as particles pop up or disappear.</p>
<p>Attention! The object pool game programming design pattern is on its way to rescue the programmer in distress!</p>
<p>I&quot;d encourage you to read through <a class="text-contentLink text-xl" href="http://gameprogrammingpatterns.com/object-pool.html">this wonderful article</a> to get to know this common pattern. In brief, we basically keep a collection of pre-created objects (pool) that will be retrieved as necessary. We could have a pool with 1000 particle effects, every time we need an explosion in our game we just ask the pool for one. Right after we&quot;re done with it, we put it back. As a consequence, we won&#x27;t require to allocate memory every time we need a fancy explosion since the pool will be created during launch.</p>
<p>Luckily enough, libgdx provides the Pool abstract class and the Poolable interface to achieve this behavior (had we seen ourselves in the need to come up with an implementation, it wouldn&#x27;t have been the end of the world either).</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">abstract public class Pool {
	public Pool ();
	public Pool (int initialCapacity);
	public Pool (int initialCapacity, int max);

	abstract protected T newObject ();

	public T obtain ();
	public void free (T object);
	public void freeAll (Array objects);
	public void clear ();

	static public interface Poolable {
		public void reset ();
	}
}</code></pre></div>
<p>As you can probably deduce after reading the previous snippet, in order to make a resource poolable it&#x27;s required to implement the reset() method of such interface. Then you need to create a new <a class="text-contentLink text-xl" href="http://libgdx.badlogicgames.com/nightlies/docs/api/com/badlogic/gdx/utils/Pool.html">Pool</a> class that implements the newObject() method which means the poolable object must provide a default constructor. Easy peasy. However, if by any chance you come across any problems while implementing this yourself, take a look at the official documentation or at this <a class="text-contentLink text-xl" href="http://www.ziggysgames.com/my-weapon-bullet-system-using-artemis-and-libgdx-box2d">sample to have efficient bullets</a>.</p>
<img class="mb-1" src="/img/freegemas/freegemas-03.webp" alt="/img/freegemas/freegemas-03.png"/>
<p>For those who remain skeptic, I used the libgdx ParticleEffectPool class in Freegemas to enhance efficiency with noticeable improvements in mobile devices. Every time you connect a group of 3 or more gems you get a sparkle effect right away. Even though this can be found in the Freegemas game state class implementation, I&quot;ll attach the interesting bits below.</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">// Create prototype effect
ParticleEffect effect = new ParticleEffect();
effect.load(Gdx.files.internal(&amp;quot;data/particleStars&amp;quot;), Gdx.files.internal(&amp;quot;data&amp;quot;));

// Create effects pool using thay prototype
ParticleEffectPool effectPool = new ParticleEffectPool(effect, 20, 100);
// Add new effect and enable it
ParticleEffect effect = effectPool.obtain();
effect.start();

// Put effect back in pool (first check if it has finished)
if (effect.isComplete()) {
	effectPool.free(effect);
}</code></pre></div>
<p>Here we go, GC friendly particles. Neat, isn&#x27;t it?</p>
<h3>Still in trouble? Do some profiling</h3>
<blockquote>
<p>Alright, I&quot;m pretty sure your advice is utter bullshit, my app is still laggy! I want my money back.</p>
</blockquote>
<img class="mb-1" src="/img/wp/visualvm.webp" alt="visualvm-300x187.png"/>
<p>Before throwing that rotten tomato you&quot;re waving in anger, please consider giving profiling a shot. Get VisualVM, make it analyze your game while it&#x27;s running and take a close look at the results. You might find out that a seemingly harmless method is consuming an obscene amount of CPU time. Who knows, perhaps you&#x27;ve missed several memory allocations within the game loop. Despite of its simplicity, yes, I will tackle profiling with depth further ahead in this very same blog.</p>
<p>Promise.</p></article></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"metadata":{"path":"content/post/2013-01-29-beware-memory-allocation.mdx","title":"Beware memory allocation","date":"2013-01-29T19:02:03.000Z","categories":["Games development"],"series":null,"description":null,"slug":"beware-memory-allocation","readingTime":"8 min read","draft":false,"disableComments":false,"keywords":[],"banner":null},"source":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    a: \"a\",\n    img: \"img\",\n    h3: \"h3\",\n    em: \"em\",\n    blockquote: \"blockquote\",\n    div: \"div\",\n    pre: \"pre\",\n    code: \"code\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsxs(_components.p, {\n      children: [\"I bet you already know that keeping memory allocation under control in real time applications is absolutely essential. Bad memory management in non \", _jsx(_components.a, {\n        href: \"http://en.wikipedia.org/wiki/Garbage_collection_(computer_science)\",\n        children: \"garbage collected languages\"\n      }), \", say C++, results in irresponsible footprints. $deity forbid we incur in a std::bad_alloc exception! That can be a deal breaker for mobile phones or consoles. However, the other family of languages is what really haunts me. In Java, for instance, the consequences of not giving a monkey's about memory won't necessarily make your game crash. Nonetheless, it can be silently devastating to the point of dragging your frame rate below ground absent previous notice.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"You don't want that now, do you?\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Please, let me take a step back and point out the irony of having to be extremely careful with memory usage in the presence of a garbage collector (GC) when dealing with real time problems. It's often said that it takes the responsibility off you. In a beautiful world where code tastes like lollipop it would, but this is really not the case. At least not entirely.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"This article is aimed at developers who code in GC environments to make real time applications. Concepts here also apply to broader fields in spite of the focus mainly being Java and games development using the libgdx framework. Actually, I decided to write this post after seeing the same performance related questions \", _jsx(_components.a, {\n        href: \"http://www.badlogicgames.com/forum/viewtopic.php?f=11\u0026t=3572\",\n        children: \"over\"\n      }), \" and \", _jsx(_components.a, {\n        href: \"http://www.badlogicgames.com/forum/viewtopic.php?f=11\u0026t=6785\u0026hilit=performance+garbage\",\n        children: \"over\"\n      }), \" again in the libgdx forums. Most of them are closely tied to memory allocation.\"]\n    }), \"\\n\", _jsx(_components.img, {\n      src: \"/img/wp/garbage-collector-strikes-back.webp\",\n      alt: \"garbage-collector-strikes-back.jpg\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Be aware of the GC and why it's critical in mobile/consoles\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The GC is fired up every now and then and asks: \", _jsx(_components.em, {\n        children: \"\\\"what objects are currently not being referenced by any variable?\\\"\"\n      }), \". The next step is freeing the memory those objects were occupying so it becomes available for other purposes. It keeps the playground clean and neat and that's awesome to some extent. Surely enough, this might not cause too much trouble in classic applications. However, it can be deadly in a situation where you have less than 1/60s to compute a discrete simulation step.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Note: I just told a white lie. JVM's GC actually follows several strategies to free up unused memory as pointed out in \", _jsx(_components.a, {\n        href: \"http://stackoverflow.com/questions/1582209/java-garbage-collector-when-does-it-collect\",\n        children: \"this Stack Overflow post\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"A common mistake, which I've made myself with \", _jsx(_components.a, {\n        href: \"/freegemas/\",\n        children: \"Freegemas\"\n      }), \", is to believe my game is well optimized because it runs flawlessly on an i7 machine. Don't fool yourself, go on and deploy your libgdx app on a mid tier Android phone and see what happens.\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"Oh well… This is disappointing…\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Mobile devices and consoles typically fall short on memory. You miss those 16GB of RAM, don't you? Moreover, every time the GC decides to intervene, the stall becomes more noticeable due to the less powerful CPU.\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"Oh noes!\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Long story short, we need to prevent this from happening as much as we possibly can.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Cache temporal variables as data members\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"It goes without saying that some memory allocation is needed. Don't worry about loading your assets at sensible times as well as creating game objects to get things ready. Nevertheless, avoid making use of the new operator inside your game loop at any cost.\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"Sometimes I do need some auxiliary, yet costly, objects to perform calculations every frame.\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Worry no more as you can make them private data members. As cheeky as it may sound, this will spare you a fair amount of problems.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"I\\\"m currently working on a GLEED level system refactor and I think the renderer class could serve us as an perfect example. I use two Rectangle objects (Axis Aligned Bounding Boxes) to perform frustum culling: the first one represents the camera while the second one corresponds to the texture we might or might not render. Those two Rectangle objects don't naturally belong to the GLEEDMapRenderer themselves, but why would I allocate memory for new instances every single frame. That\\\"d make the GC sad. Instead, take a look at this simplified snippet.\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-unknown\",\n        children: _jsx(_components.code, {\n          className: \"language-unknown\",\n          children: \"public class GleedMapRenderer implements MapRenderer, Disposable {\\n\\n\\t// Renderer data\\n\\tprivate GleedMap m_map;\\n\\tprivate SpriteBatch m_batch;\\n\\tprivate boolean m_ownSpriteBatch;\\n\\tprivate float m_mpp;\\n\\n\\t// Aux data for fustrum culling\\n\\tprivate Rectangle m_box = new Rectangle();\\n\\tprivate Rectangle m_camera = new Rectangle();\\n\\n\\tpublic void render(OrthographicCamera camera) {\\n\\t\\tm_camera.x = camera.position.x - camera.viewportWidth * 0.5f * camera.zoom;\\n\\t\\tm_camera.y = camera.position.y - camera.viewportHeight * 0.5f * camera.zoom;\\n\\t\\tm_camera.width = camera.viewportWidth *  camera.zoom;\\n\\t\\tm_camera.height = camera.viewportHeight *  camera.zoom;\\n\\n\\t\\tsetProjectionMatrix(camera.combined);\\n\\n\\t\\tMapLayers layers = m_map.getLayers();\\n\\n\\t\\tfor (MapLayer layer : layers) {\\n\\t\\t\\trenderLayer(layer);\\n\\t\\t}\\n\\t}\\n\\n\\tprivate void renderLayer(MapLayer layer) {\\n\\n\\t\\tif (!layer.getVisible()) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tMapObjects objects = layer.getObjects();\\n\\t\\tint numObjects = objects.getNumObjects();\\n\\n\\t\\tfor (int j = 0; j \u0026lt; numObjects; ++j) {\\n\\t\\t\\tMapObject mapObject = objects.getObject(j);\\n\\n\\t\\t\\tif (mapObject == null || !mapObject.getVisible()) {\\n\\t\\t\\t\\tcontinue;\\n\\t\\t\\t}\\n\\n\\t\\t\\tif (!(mapObject instanceof TextureMapObject)) {\\n\\t\\t\\t\\tcontinue;\\n\\t\\t\\t}\\n\\n\\t\\t\\tTextureMapObject texture = (TextureMapObject)mapObject;\\n\\n\\t\\t\\tsetBounds(texture);\\n\\n\\t\\t\\t// If the image is in the frustum, draw it (culling)\\n\\t\\t\\tif (m_camera.overlaps(m_box) ||\\n\\t\\t\\t    m_camera.contains(m_box) ||\\n\\t\\t\\t    m_box.contains(m_camera)) {\\n\\n\\t\\t\\t\\t...\\n\\t\\t\\t}\\n\\t\\t}\\n\\t}\\n}\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"As illustrated above, the Rectangle instances are created along the renderer and properly set every frame. Consequently, what initially would have involved memory allocations, assignments and GC activity is reduced to just a few unavoidable assignments. Let's mention it once again, in spite of rectangles being cheap, you don't want to mess with the GC on mobile devices!\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Consider object pooling\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Unfortunately, at some point you will find yourself in the need of constantly creating dozens of big sized objects. It's a common problem when dealing with spawning game entities, particle effects and the like. Say you\\\"re making a space shooter, of course you want hundreds of flashy explosions and lasers! You\\\"ll face a problem, that can drive the GC crazy as particles pop up or disappear.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Attention! The object pool game programming design pattern is on its way to rescue the programmer in distress!\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"I\\\"d encourage you to read through \", _jsx(_components.a, {\n        href: \"http://gameprogrammingpatterns.com/object-pool.html\",\n        children: \"this wonderful article\"\n      }), \" to get to know this common pattern. In brief, we basically keep a collection of pre-created objects (pool) that will be retrieved as necessary. We could have a pool with 1000 particle effects, every time we need an explosion in our game we just ask the pool for one. Right after we\\\"re done with it, we put it back. As a consequence, we won't require to allocate memory every time we need a fancy explosion since the pool will be created during launch.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Luckily enough, libgdx provides the Pool abstract class and the Poolable interface to achieve this behavior (had we seen ourselves in the need to come up with an implementation, it wouldn't have been the end of the world either).\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-unknown\",\n        children: _jsx(_components.code, {\n          className: \"language-unknown\",\n          children: \"abstract public class Pool {\\n\\tpublic Pool ();\\n\\tpublic Pool (int initialCapacity);\\n\\tpublic Pool (int initialCapacity, int max);\\n\\n\\tabstract protected T newObject ();\\n\\n\\tpublic T obtain ();\\n\\tpublic void free (T object);\\n\\tpublic void freeAll (Array objects);\\n\\tpublic void clear ();\\n\\n\\tstatic public interface Poolable {\\n\\t\\tpublic void reset ();\\n\\t}\\n}\"\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"As you can probably deduce after reading the previous snippet, in order to make a resource poolable it's required to implement the reset() method of such interface. Then you need to create a new \", _jsx(_components.a, {\n        href: \"http://libgdx.badlogicgames.com/nightlies/docs/api/com/badlogic/gdx/utils/Pool.html\",\n        children: \"Pool\"\n      }), \" class that implements the newObject() method which means the poolable object must provide a default constructor. Easy peasy. However, if by any chance you come across any problems while implementing this yourself, take a look at the official documentation or at this \", _jsx(_components.a, {\n        href: \"http://www.ziggysgames.com/my-weapon-bullet-system-using-artemis-and-libgdx-box2d\",\n        children: \"sample to have efficient bullets\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.img, {\n      src: \"/img/freegemas/freegemas-03.webp\",\n      alt: \"/img/freegemas/freegemas-03.png\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"For those who remain skeptic, I used the libgdx ParticleEffectPool class in Freegemas to enhance efficiency with noticeable improvements in mobile devices. Every time you connect a group of 3 or more gems you get a sparkle effect right away. Even though this can be found in the Freegemas game state class implementation, I\\\"ll attach the interesting bits below.\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-unknown\",\n        children: _jsx(_components.code, {\n          className: \"language-unknown\",\n          children: \"// Create prototype effect\\nParticleEffect effect = new ParticleEffect();\\neffect.load(Gdx.files.internal(\u0026quot;data/particleStars\u0026quot;), Gdx.files.internal(\u0026quot;data\u0026quot;));\\n\\n// Create effects pool using thay prototype\\nParticleEffectPool effectPool = new ParticleEffectPool(effect, 20, 100);\\n// Add new effect and enable it\\nParticleEffect effect = effectPool.obtain();\\neffect.start();\\n\\n// Put effect back in pool (first check if it has finished)\\nif (effect.isComplete()) {\\n\\teffectPool.free(effect);\\n}\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Here we go, GC friendly particles. Neat, isn't it?\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Still in trouble? Do some profiling\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"Alright, I\\\"m pretty sure your advice is utter bullshit, my app is still laggy! I want my money back.\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.img, {\n      src: \"/img/wp/visualvm.webp\",\n      alt: \"visualvm-300x187.png\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Before throwing that rotten tomato you\\\"re waving in anger, please consider giving profiling a shot. Get VisualVM, make it analyze your game while it's running and take a close look at the results. You might find out that a seemingly harmless method is consuming an obscene amount of CPU time. Who knows, perhaps you've missed several memory allocations within the game loop. Despite of its simplicity, yes, I will tackle profiling with depth further ahead in this very same blog.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Promise.\"\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","scope":{}},"series":null},"__N_SSG":true},"page":"/[slug]","query":{"slug":"beware-memory-allocation"},"buildId":"mvqSgSk1RJnIqiv3GiBne","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>