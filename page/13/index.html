<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta name="generator" content="Hugo 0.63.1" />
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

  <title>David Saltares &middot; David Saltares</title>

  
  <link rel="stylesheet" href="../../css/poole.css">
  <link rel="stylesheet" href="../../css/hyde.css">
  <link rel="stylesheet" href="../../css/poole-overrides.css">
  <link rel="stylesheet" href="../../css/hyde-overrides.css">
  <link rel="stylesheet" href="../../css/hyde-x.css">
  <link rel="stylesheet" href="../../css/highlight/zenburn.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../touch-icon-144-precomposed.png">
  <link href="../../img/favicon.png" rel="icon">

  
  
  
  <link href="%7balternate%20%7bRSS%20application/rss&#43;xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20https://saltares.com/index.xml%7d" rel="alternate" type="application/rss+xml" title="David Saltares &middot; David Saltares" />

  <meta name="description" content="">
  <meta name="keywords" content="">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-4440744-3', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="../../"><img src="../../img/profile.jpg"
             alt="profile-picture" id="profile-img" title="David Saltares"></a>
      <h1><a href="../../">David Saltares</a></h1>
      <p class="lead">Software Development</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="../../">Blog</a></li>
      
      <li class="sidebar-nav-item"><a href="../../about">About</a></li>
      
      <li class="sidebar-nav-item"><a href="../../apps-tools">Apps &amp; Tools</a></li>
      
      <li class="sidebar-nav-item"><a href="../../game-jams">Game Jams</a></li>
      
      <li class="sidebar-nav-item"><a href="../../games">Games</a></li>
      
      <li class="sidebar-nav-item"><a href="../../libgdx-cross-platform-game-development-cookbook">Libgdx Cookbook</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="http://github.com/dsaltares"><i class="fa fa-github-square fa-2x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/davidsaltares"><i class="fa fa-linkedin-square fa-2x"></i></a>
      
      
      <a href="http://twitter.com/d_saltares"><i class="fa fa-twitter-square fa-2x"></i></a>
      <a href="https://www.youtube.com/channel/UCw375yUExJOVIEHmvmPFWyg"><i class="fa fa-youtube-square fa-2x"></i></a>
      <a href="../../index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-2x"></i></a>
      </li>
    </ul>

    

    <div class="copyright">
      <p>
        &copy; 2020 David Saltares.<br/>
        Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X.</a><br/>
        Hosted on <a href="https://pages.github.com/">Github Pages</a>.
      </p>
    </div>
  </div>
</div>


<div class="content container">
  <div class="posts">
    
    
    <div class="post">
      <h1 class="post-title">
        <a href="https://saltares.com/general/homefront-the-revolution-e3-stage-demo/">Homefront: The Revolution E3 stage demo</a>
      </h1>
      <span class="post-date">Jun 11, 2014 &middot; <a href="https://saltares.com/general/homefront-the-revolution-e3-stage-demo/#disqus_thread">Comments</a>
      
      <br/>
      <a class="label" href="../../categories/general">General</a>
      </span>
      
      <p>You&rsquo;ll have to excuse some Homefront: The Revolution spam in the blog these days. E3 2014 is on and, for the very first time, they&rsquo;re showing gameplay of the game I worked on at Crytek UK for two years. Exciting!</p>
<p>Without further ado, I&rsquo;ll let you see how awesome it looks.</p>
<!-- raw HTML omitted -->

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="https://saltares.com/general/homefront-the-revolution-announced/">Homefront: The Revolution announced!</a>
      </h1>
      <span class="post-date">Jun 2, 2014 &middot; <a href="https://saltares.com/general/homefront-the-revolution-announced/#disqus_thread">Comments</a>
      
      <br/>
      <a class="label" href="../../categories/general">General</a>
      </span>
      
      <p>At last! The game I worked on during my 2 years at Crytek UK has been announced with an amazing trailer. Big congratulations at the Nottingham team for the huge effort put into this project. What a bunch of incredibly talented people, I&rsquo;m really honoured to have been part of the project.</p>
<p>I mainly worked on emergent AI systems for NPCs and animation. Unfortunately, you cannot see much of that on this trailer. Let&rsquo;s wait and see for E3!</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/qEDNU6oOQqI" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="https://saltares.com/games/ludum-dare-29-beneath-the-surface/">Ludum Dare #29: Beneath the surface</a>
      </h1>
      <span class="post-date">Apr 29, 2014 &middot; <a href="https://saltares.com/games/ludum-dare-29-beneath-the-surface/#disqus_thread">Comments</a>
      
      <br/>
      <a class="label" href="../../categories/games-development">Games development</a>
      </span>
      
      <p><img src="../../img/ld29/beneath-the-surface-title.png" alt="beneath-the-surface-title.png"></p>
<p>As I mentioned here a few days ago, last weekend I entered the 29th edition of the <a href="http://www.ludumdare.com">Ludum Dare</a> game jam, which had <em>Beneath the surface</em> as a theme. To be completely honest, I was only bothered to work on the project for about 4 hours each day. That probably explains why is my worst <a href="../../game-jams/">game jam</a> entry so far.</p>
<p>Beneath the surface is a very simple, classic text adventure where the player needs to escape an underground cave by using commands in the form of <code>verb object</code> like:</p>
<blockquote>
<p>Open door</p>
</blockquote>
<p><img src="../../img/ld29/beneath-the-surface.png" alt="beneath-the-surface.png"></p>
<p>The game is too basic and needed more user testing before the deadline. I was quite unhappy with it but then thought I&rsquo;d rather submit it than dropping out completely. But hey, at least I managed to work on shaders a little bit, an area I really need to get better at.</p>
<p>Maybe next time I&rsquo;ll manage to pull off something better.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="https://saltares.com/games/ludum-dare-29-im-in/">Ludum Dare #29: I&#39;m in!</a>
      </h1>
      <span class="post-date">Apr 25, 2014 &middot; <a href="https://saltares.com/games/ludum-dare-29-im-in/#disqus_thread">Comments</a>
      
      <br/>
      <a class="label" href="../../categories/games-development">Games development</a>
      </span>
      
      <p><img src="../../img/wp/ludum-dare.png" alt="ludum-dare.png"></p>
<p>I&rsquo;m up for Ludum Dare despite not being too sure about whether or not I&rsquo;ll be able to invest enough time on it. The last couple of editions eluded me, so I didn&rsquo;t want to miss yet another one.</p>
<p>Given the time constraints, I might even go for just a text adventure. Or maybe not, who knows. I&rsquo;ll decide in the morning, once the theme is announced!</p>
<p>Tools of the trade.</p>
<ul>
<li><strong>Language</strong>: Java with Eclipse</li>
<li><strong>Libraries</strong>: <a href="libgdx.badlogicgames.com">Libgdx</a> (what a surprise) with no previous codebase. I might use additional libraries if needed, though.</li>
<li><strong>Graphics</strong>: <a href="http://www.inkscape.org/en/">Inkscape</a></li>
<li><strong>Audio</strong>: <a href="http://audacity.sourceforge.net/">Audacity</a>, <a href="http://www.drpetter.se/project_sfxr.html">SFXR</a> and <a href="http://www.abundant-music.com/">this procedural music generator</a></li>
</ul>
<p>It is on!</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="https://saltares.com/computing/listenerset-using-variadic-templates/">ListenerSet using variadic templates</a>
      </h1>
      <span class="post-date">Apr 24, 2014 &middot; <a href="https://saltares.com/computing/listenerset-using-variadic-templates/#disqus_thread">Comments</a>
      
      <br/>
      <a class="label" href="../../categories/computing">Computing</a>
      </span>
      
      <p><strong>Important</strong>: variadic templates are only available from C++11, make sure your compiler supports it.</p>
<p>Who has never used the <a href="http://en.wikipedia.org/wiki/Observer_pattern">Observer</a> pattern? As long as you have been involved in any medium sized project, chances are you have come across it at some point.</p>
<h3 id="the-problem">The problem</h3>
<p>It is extremely common to have an event generating system other components would like to subscribe to. However, oftentimes I see code to manage a collection of listeners being unnecessarily duplicated on a per system basis. That is registration, un-registration and notification. A lot of nonsensical boilerplate, which makes for code that is harder to read and easier to get wrong.</p>
<p>Let&rsquo;s take a look at a typical input event dispatching system, simplified for the purposes of this article. We could have an <code>IInputListener</code> interface that handles a couple of events, <code>keyDown()</code> and <code>keyUp()</code>.</p>
<pre><code>struct IInputListener
{
    virtual ~IInputListener() {}
    virtual bool keyDown(KeyCode code) = 0;
    virtual bool keyUp(KeyCode code) = 0;
};
</code></pre><p>Our <code>InputSystem</code> class could hold an <code>std::set</code> of <code>IInputListener</code> pointers. Registration and un-registration is made possible through <code>addListener()</code> and <code>removeListener()</code> respectively. Bad news is that, every single time we want to send an event to the listeners, we are forced to iterate over the collection. Also, God kills a kitten.</p>
<pre><code>class InputSystem
{
public:
    void addListener(IInputListener* listener)
    {
        m_listeners.insert(listener);
    }

    void removeListener(IInputListener* listener)
    {
        m_listeners.erase(listener);
    }

    void update()
    {
        // Touch down detected
        for (auto listener : m_listeners)
        {
            listener-&gt;keyDown(code);
        }

        ...

        // Touch up detected
        for (auto listener : m_listeners)
        {
            listener-&gt;keyUp(code);
        }
    }

private:
    std::set&lt;IInputListener*&gt; m_listeners;
};
</code></pre><p>As if this wasn&rsquo;t enough, there is another important <em>gotcha</em> here. What happens when a listener un-registers as a result of an event? The <code>m_listeners</code> collection is modified in the middle of the <code>for</code> loop, thus current iterators are no longer valid. The second we try to increment the internal iterator to fetch the next listener.</p>
<blockquote>
<p>BAM!</p>
</blockquote>
<p>Not good.</p>
<p>The solution is simple but annoying. We can just add new listener registration and un-registration requests to a pending list while in the middle of a dispatch. Those pending lists would be processed once it&rsquo;s safe to modify the collection of listeners.</p>
<p>Moreover, some people use <code>std::vector</code> instead of <code>std::set</code> for performance reasons, which is completely legit. However, that involves adding code to ensure listener uniqueness in the collection.</p>
<p>Every time.</p>
<p>Honestly? I&rsquo;m lazy so I don&rsquo;t want to be the guy who implements this over and over.</p>
<blockquote>
<p>Okay, so what do you suggest?</p>
</blockquote>
<h3 id="the-way-towards-the-solution">The way towards the solution</h3>
<p>Following our intuition, we realise that a way to generalise this behaviour is in order. Ideally, it would meet the following criteria.</p>
<ul>
<li>Avoids all code duplication.</li>
<li>Ensures listener uniqueness.</li>
<li>It is safe, can register, un-register while notifying.</li>
<li>Avoids manually going through the listener collection to send an event.</li>
<li>Compatible with any kind of event listener.</li>
</ul>
<p>Intuitively, we could have a <code>ListenerSet&lt;Type&gt;</code> template class that handles listener duplication as well as registration and un-registration safety.</p>
<p><strong>Note</strong>: we&rsquo;ll be using <code>std::set</code> rather than <code>std::vector</code> for simplicity. Both can be used as long as the appropriate precautions are taken.</p>
<pre><code>template &lt;class Type&gt; class ListenerSet
{
public:
    ListenerSet() {}
    virtual ~ListenerSet() {}

    inline void addListener(Type listener)
    {
        if (m_notifying)
        {
            m_pendingAddition.insert(listener);
            m_pendingRemoval.erase(listener);
        }
        else
        {
            m_listeners.insert(listener);
        }
    }

    inline void removeListener(Type listener)
    {
        if (m_notifying)
        {
            m_pendingRemoval.insert(listener);
            m_pendingAddition.erase(listener);
        }
        else
        {
            m_listeners.erase(listener);
        }
    }

private:
    bool m_notifying;
    std::set&lt;Type&gt; m_pendingRemoval;
    std::set&lt;Type&gt; m_pendingAddition;
    std::set&lt;Type&gt; m_listeners;
};
</code></pre><p>We&rsquo;re missing the notification functionality, that&rsquo;s the tricky part. We would like to have an interface such as to be able to do something like this.</p>
<pre><code>m_listenerSet.notify(&amp;IInputListener::keyDown, keyCode);
</code></pre><p><code>ListenerSet::notify()</code> would iterate over all the registered listeners calling <code>IInputListener::keyDown</code> and passing <code>keyCode</code> as a parameter.</p>
<blockquote>
<p>Maybe easier said than done?</p>
</blockquote>
<p>True, <code>ListenerSet::notify()</code> needs to support an arbitrary number of arguments, as different event handlers won&rsquo;t necessarily have the same signature. Moreover, <code>IInputListener::keyDown</code>(and every other potential handler) needs to receive a <code>this</code> pointer along the remaining arguments.</p>
<p>This is where <a href="http://www.cplusplus.com/articles/EhvU7k9E/">variadic templates</a> come into play. Basically, they&rsquo;re templates that can take an arbitrary number of parameters of any type.</p>
<p>Interestingly enough, <code>std::bind()</code> also takes an arbitrary number of parameters. That means we can create an <code>std::function&gt;</code> object that has everything we need: the event handler function pointer, <code>this</code> and the remaining arguments.</p>
<p>Take a look at the code.</p>
<pre><code>template &lt;class Function, class... Arguments&gt;
inline void notify(Function&amp;&amp; f, Arguments&amp;&amp;... args)
{
    m_notifying = true;
    for (Type listener : m_listeners)
    {
        auto callback = std::bind(f, listener, args...);
        callback(listener);
    }
    m_notifying = false;

    for (Type listener : m_pendingRemoval)
    {
        m_listeners.erase(listener);
    }

    m_pendingRemoval.clear();

    for (Type listener : m_pendingAddition)
    {
        m_listeners.insert(listener);
    }

    m_pendingAddition.clear();
}
</code></pre><p>Note how we process the pending requests to add or remove listeners after we finish sending the events, that&rsquo;s when it&rsquo;s safe.</p>
<p>Now we can do exactly what we wanted!</p>
<pre><code>ListenerSet&lt;IInputListener*&gt; listeners;

listeners.addListener(new PlayerInputListener());
listeners.addListener(new UserInterfaceInputListener());

m_listenerSet.notify(&amp;IInputListener::keyDown, keyCode);
m_listenerSet.notify(&amp;IInputListener::keyUp, keyCode);
</code></pre><p>Templates are instantiated at compile time, which means the compiler will complain if we&rsquo;re doing something dodgy such as trying to bind the wrong thing. Compile time checks are good.</p>
<p>Managing a set of listeners and sending events is now a lot easier, safer and readable. Last but not least, it&rsquo;s significantly less error prone.</p>
<blockquote>
<p>Hooray!!!</p>
</blockquote>
<h3 id="full-source">Full source</h3>
<p>For those interested, I&rsquo;ve made the code available as a GitHub Gist.</p>
<p><a href="https://gist.github.com/dsaltares/11212605">ListenerSet implementation</a></p>

      
    </div>
    
        <div class=pagination>
        <ul class="pagination">
            <li>
                <a href="../../">««</a>
            </li>
            
            <li>
                <a href="../../page/12/">«</a>
            </li>
            
            <li class="active">
                <a href="../../page/13/">13</a>
            </li>
            
            <li>
                <a href="../../page/14/">»</a>
            </li>
            
            <li>
                <a href="../../page/60/">»»</a>
            </li>
        </ul>
    </div>
  </div>
</div>


<script type="text/javascript">
var disqus_shortname = "siondream";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>


<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="../../js/load-photoswipe.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
</body>
</html>

